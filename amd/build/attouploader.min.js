/**
 * Uploader Script used in atto plugin.
 *
 * @copyright (C) 2019-2023 Yamaguchi University (gh-cc@mlex.cc.yamaguchi-u.ac.jp)
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("atto_yukaltura/attouploader",["jquery"],(function($){return{init:function(){var fileName="",fileSize=0,uploadFileType="",naturalWidth=0,naturalHeight=0,MEDIA_TYPE_VIDEO=1,MEDIA_TYPE_IMAGE=2,MEDIA_TYPE_AUDIO=5,AUTO_FINALIZE_NULL=-1,ENTRY_STATUS={ENTRY_IMPORTING:-2,ENTRY_CONVERTING:-1,ENTRY_IMPORT:0,ENTRY_PRECONVERT:1,ENTRY_READY:2,ENTRY_DELETED:3,ENTRY_PENDING:4,ENTRY_MODERATE:5,ENTRY_BLOCKED:6,ENTRY_NO_CONTENT:7},UPLOAD_TOKEN_STATUS_PENDING=0,UPLOAD_TOKEN_STATUS_PARTIAL_UPLOAD=1,UPLOAD_TOKEN_STATUS_FULL_UPLOAD=2,createObjectURL=window.URL&&window.URL.createObjectURL?function(file){return window.URL.createObjectURL(file)}:window.webkitURL&&window.webkitURL.createObjectURL?function(file){return window.webkitURL.createObjectURL(file)}:void 0,revokeObjectURL=window.URL&&window.URL.revokeObjectURL?function(file){return window.URL.revokeObjectURL(file)}:window.webkitURL&&window.webkitURL.revokeObjectURL?function(file){return window.webkitURL.revokeObjectURL(file)}:void 0;function checkForm(){null===$("#fileData")||null===$("#fileData").files||""===$("#name").val()||""===$("#tags").val()||""===$("#type").val()||"N/A"===$("#type").val()?($("#entry_submit").prop("disabled",!0),$("#entry").val("")):$("#entry_submit").prop("disabled",!1)}function checkFileSize(){return!(fileSize<=0)&&!(fileSize>2e9)}function checkNameString(str){return!0!==/["$%&'~^\\`/]/.test(str)}function handleSubmitClick(){return!1!==(nameStr=$("#name").val(),tagsStr=$("#tags").val(),descStr=$("#description").val(),flag=!0,!1===checkNameString(nameStr)&&(require(["core/str"],(function(str){var message=str.get_string("wrong_name","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),flag=!1),0==(!0!==/[!"#$%&'~|^\\@`()[\]{}:;+*/=<>?]/.test(tagsStr))&&(require(["core/str"],(function(str){var message=str.get_string("wrong_tags","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),flag=!1),!1===checkNameString(descStr)&&(require(["core/str"],(function(str){var message=str.get_string("wrong_desc","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),flag=!1),flag)&&(!1===checkFileSize()?(require(["core/str"],(function(str){var message=str.get_string("wrong_filesize","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),!1):($("#entry_submit").prop("disabled",!0),serverHost=$("#kalturahost").val(),ks=$("#ks").val(),disableInsertButton(),$("#yukaltura_cancel_btn",parent.document).prop("disabled",!0),$("#yukaltura_cancel_btn",parent.document).css({opacity:"0.5"}),function(){if(null===parent.document.getElementById("yukaltura_select_id")||null===parent.document.getElementById("yukaltura_select_id")[0]){var element=$("body",parent.document),str='<input type="hidden" name="yukaltura_select_id" id="yukaltura_select_id" value="">';element.append(str),str='<input type="hidden" name="yukaltura_select_name" id="yukaltura_select_name" value="">',element.append(str),str=(str='<input type="hidden" name="yukaltura_host" id="yukaltura_host" value="')+$("#kalturahost").val()+'">',element.append(str),str=(str='<input type="hidden" name="yukaltura_partnerid" id="yukaltura_partnerid" value="')+$("#partnerid").val()+'">',element.append(str),str=(str='<input type="hidden" name="yukaltura_uiconfid" id="yukaltura_uiconfid" value="')+$("#uiconfid").val()+'">',element.append(str),str='<input type="hidden" name="yukaltura_width" id="yukaltura_width" value="'+$("#player_width").val()+'">',element.append(str),str='<input type="hidden" name="yukaltura_height" id="yukaltura_height" value="'+$("#player_height").val()+'">',element.append(str),str='<input type="hidden" name="yukaltura_playerstudio" id="yukaltura_playerstudio" value="'+$("#player_studio").val()+'">',element.append(str),str='<input type="hidden" name="yukaltura_filetype" id="yukaltura_filetype" value="',str+=uploadFileType+'">',element.append(str),str='<input type="hidden" name="yukaltura_filetype" id="yukaltura_filetype" value="">',element.append(str),str='<input type="hidden" name="yukaltura_naturalwidth" id="yukaltura_naturalwidth" value="">',element.append(str),str='<input type="hidden" name="yukaltura_naturalheight" id="yukaltura_naturalheight" value="">',element.append(str)}}(),function(serverHost,ks){var uploadTokenId,findData,file=$("#fileData").prop("files")[0];fileSize=parseInt(encodeURI(file.size));var postData={type:"GET",cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",dataType:"xml"},serviceURL=serverHost+"/api_v3/service/uploadToken/action/add?ks="+ks;serviceURL=(serviceURL=(serviceURL=(serviceURL+="&uploadToken:objectType=KalturaUploadToken")+"uploadToken:fileName="+encodeURI(fileName))+"&uploadToken:fileSize="+fileSize)+"&uploadToken:autoFinalize="+AUTO_FINALIZE_NULL,$.ajax(serviceURL,postData).done((function(xmlData){if(null!==xmlData)if(null===(findData=$(xmlData).find("code"))||void 0===typeof findData||""===findData.text())if(null!==(findData=$(xmlData).find("status"))&&void 0!==typeof findData&&""!==findData.text()){var uploadTokenStatus=findData.text();uploadTokenStatus==UPLOAD_TOKEN_STATUS_PENDING?null!==(findData=$(xmlData).find("id"))&&void 0!==typeof findData&&""!==findData.text()?(uploadTokenId=findData.text(),setTimeout((function(){!function(serverHost,ks,uploadTokenId){var findData,entryStatus,entryId="",entryName="",entryTags="",entryDescription="",entryCreatorId="",nameStr=$("#name").val(),tagsStr=$("#tags").val(),descStr=$("#description").val(),controlId=$("#controlId").val(),creatorId=$("#creatorId").val();nameStr=nameStr.trim(),tagsStr=tagsStr.trim(),null!==descStr&&(descStr=descStr.trim());var fd=new FormData;fd.append("action","add"),fd.append("ks",ks),fd.append("entry:objectType","KalturaMediaEntry");var type=$("#type").val(),mediaType="";mediaType="image"==type?MEDIA_TYPE_IMAGE:"audio"==type?MEDIA_TYPE_AUDIO:MEDIA_TYPE_VIDEO,fd.append("entry:mediaType",mediaType),fd.append("entry:sourceType",1),fd.append("entry:name",nameStr),fd.append("entry:tags",tagsStr),null!==descStr&&""!==descStr?fd.append("entry:description",descStr):fd.append("entry:description",""),fd.append("entry:categories",$("#categories").val()),null!==controlId&&""!==controlId&&fd.append("entry:accessControlId",controlId),fd.append("entry:creatorId",creatorId),fd.append("entry:userId",creatorId);var postData={type:"POST",data:fd,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml"},serviceURL=serverHost+"/api_v3/service/media/action/add";$.ajax(serviceURL,postData).done((function(xmlData){return null===xmlData||void 0===typeof xmlData?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entry !<br>(Cannot get a XML response.)")):null!==(findData=$(xmlData).find("code"))&&void 0!==typeof findData&&""!==findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entry !<br>("+findData.text()+")")):null===(findData=$(xmlData).find("status"))||void 0===typeof findData||""===findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entyry !<br>(Cannot get a mediaEntryStatus.)")):(entryStatus=findData.text())!=ENTRY_STATUS.ENTRY_NO_CONTENT?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entry!<br>(mediaEntryStatus: "+entryStatus+")")):(findData=$(xmlData).find("id"),entryId=findData.text(),findData=$(xmlData).find("name"),entryName=findData.text(),findData=$(xmlData).find("tags"),entryTags=findData.text(),findData=$(xmlData).find("description"),entryDescription=null!==findData&&void 0!==typeof findData&&""!==findData.text()?findData.text():"",findData=$(xmlData).find("creatorId"),entryCreatorId=findData.text(),null===entryId||""===entryId||null===entryName||""===entryName||null===entryTags||""===entryTags||null===entryCreatorId||""===entryCreatorId||""!==descStr&&(null===entryDescription||""===entryDescription)?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("There exists wrong information(s) <br>")):void setTimeout((function(){!function(serverHost,ks,uploadTokenId,entryId){var findData,fd=new FormData;fd.append("action","upload"),fd.append("ks",ks),fd.append("uploadTokenId",uploadTokenId),fd.append("fileData",$("input[name='fileData']").prop("files")[0],encodeURI(fileName),fileSize),fd.append("resume",!1),fd.append("finalChunk",!0),fd.append("resumeAt",0);var postData={type:"POST",data:fd,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml",xhr:function(){var XHR=$.ajaxSettings.xhr();return XHR.upload&&XHR.upload.addEventListener("progress",(function(e){var newValue=parseInt(e.loaded/e.total*100);$("#pvalue").html(parseInt(newValue))}),!1),XHR}};$("#upload_info").html(""),require(["core/str"],(function(str){var message=str.get_string("uploader_uploading","local_yumymedia",null);$.when(message).done((function(localizedString){$("#upload_info").append(localizedString+"<br>")}))})),require(["core/str"],(function(str){var message=str.get_string("progress","local_yumymedia",null);$.when(message).done((function(localizedString){var str="<p>"+localizedString;str+=': <span id="pvalue" style="color:#00b200">0.00</span> %</p>',$("#upload_info").append(str)}))}));var serviceURL=serverHost+"/api_v3/service/uploadToken/action/upload";$.ajax(serviceURL,postData).done((function(xmlData){if(null===xmlData)return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>(Cannot get a XML response.)");if(null!==(findData=$(xmlData).find("code"))&&void 0!==typeof findData&&""!==findData.text())return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>("+findData.text()+")");if(null===(findData=$(xmlData).find("status"))||void 0===typeof findData||""===findData.text())return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>(Cannot get an uploadTokenStatus.)");var uploadTokenStatus=findData.text();if(uploadTokenStatus!=UPLOAD_TOKEN_STATUS_FULL_UPLOAD&&uploadTokenStatus!=UPLOAD_TOKEN_STATUS_PARTIAL_UPLOAD)return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>(UPLOAD_TOKEN_STATUS : "+uploadTokenStatus+")");window.console.log("File chunk have been transmitted."),require(["core/str"],(function(str){var message=str.get_string("attach_file","local_yumymedia",null);$.when(message).done((function(localizedString){$("#upload_info").append(localizedString+"<br>")}))})),setTimeout((function(){!function(serverHost,ks,uploadTokenId,entryId){var entryStatus,findData,entryName="",entryTags="",entryDescription="",entryCreatorId="",fd=new FormData;fd.append("action","addContent"),fd.append("ks",ks),fd.append("entryId",entryId),fd.append("resource:objectType","KalturaUploadedFileTokenResource"),fd.append("resource:token",uploadTokenId);var postData={type:"POST",data:fd,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml"},serviceURL=serverHost+"/api_v3/service/media/action/addContent";$.ajax(serviceURL,postData).done((function(xmlData){return null===xmlData||void 0===typeof xmlData?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>(Cannot get a XML response.)")):null!==(findData=$(xmlData).find("code"))&&void 0!==typeof findData&&""!==findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>("+findData.text()+")")):null===(findData=$(xmlData).find("status"))||void 0===typeof findData||""===findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>(Cannot get a mediaEntryStatus.)")):(entryStatus=findData.text())!=ENTRY_STATUS.ENTRY_READY&&entryStatus!=ENTRY_STATUS.ENTRY_PENDING&&entryStatus!=ENTRY_STATUS.ENTRY_PRECONVERT&&entryStatus!=ENTRY_STATUS.IMPORT&&entryStatus!=ENTRY_STATUS.IMPORTING?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>(mediaEntryStatus: "+entryStatus+")")):(findData=$(xmlData).find("id"),entryId=findData.text(),findData=$(xmlData).find("name"),entryName=findData.text(),findData=$(xmlData).find("tags"),entryTags=findData.text(),findData=$(xmlData).find("description"),entryDescription=null!==findData&&void 0!==typeof findData&&""!==findData.text()?findData.text():"",findData=$(xmlData).find("creatorId"),entryCreatorId=findData.text(),function(id,name,tags,description,creatorId){require(["core/str","core/notification"],(function(str,notification){var strings=[{key:"upload_success",component:"local_yumymedia"},{key:"entryid_header",component:"local_yumymedia"},{key:"name_header",component:"local_yumymedia"},{key:"tags_header",component:"local_yumymedia"},{key:"desc_header",component:"local_yumymedia"},{key:"creatorid_header",component:"local_yumymedia"},{key:"insert_media",component:"atto_yukaltura"}];str.get_strings(strings).then((function(results){var output="<h3>"+results[0]+"</h3>";return output+='<table border="2" cellpadding="5">',output+="<tr><td>"+results[1]+"</td><td>"+id+"</td></tr>",output+="<tr><td>"+results[2]+"</td><td>"+name+"</td></tr>",output+="<tr><td>"+results[3]+"</td><td>"+tags+"</td></tr>",output+="<tr><td>"+results[4]+"</td><td>"+description+"</td></tr>",output+="<tr><td>"+results[5]+"</td><td>"+creatorId+"</td></tr>",output+="</table>",output+="<br>",output+='<p><font color="red">'+results[6]+"</font></p>",$("#upload_info").html(output),0})).fail(notification.exception)})),$("#yukaltura_insert_btn",parent.document).prop("disabled",!1),$("#yukaltura_insert_btn",parent.document).css({opacity:"1.0"}),enableCancelButton()}(entryId,entryName,entryTags,entryDescription,entryCreatorId),name=entryName,void(null!==(id=entryId)&&""!==id&&null!==parent.document.getElementById("yukaltura_select_id")&&null!==parent.document.getElementById("yukaltura_select_id")[0]&&($("#yukaltura_select_id",parent.document).val(id),$("#yukaltura_select_name",parent.document).val(name),$("#yukaltura_filetype",parent.document).val(uploadFileType),$("#yukaltura_naturalwidth",parent.document).val(naturalWidth),$("#yukaltura_naturalheight",parent.document).val(naturalHeight))));var id,name})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),deleteUploadToken(serverHost,ks,uploadTokenId),printErrorMessage("Cannot attach uploaded file !<br>(Cannot connect to kaltura server.)")}))}(serverHost,ks,uploadTokenId,entryId)}),1e3)})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),deleteUploadToken(serverHost,ks,uploadTokenId),printErrorMessage("Cannot upload the file !<br>(Cannot connect to contents server.)")}))}(serverHost,ks,uploadTokenId,entryId)}),50))})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),deleteUploadToken(serverHost,ks,uploadTokenId),printErrorMessage("Cannot create media entry !<br>(Cannot connect to kaltura server.)")}))}(serverHost,ks,uploadTokenId)}),50)):printErrorMessage("Cannot create uplaod token !<br>(Cannot get an uploadTokenId.)"):printErrorMessage("Cannot create upload token !<br>(UPLOAD_TOKEN_STATUS : "+uploadTokenStatus+")")}else printErrorMessage("Cannot create upload token !<br>(Cannot get status of upload token.)");else printErrorMessage("Cannot create upload token !<br>("+findData.text()+")");else printErrorMessage("Cannot create upload token !<br>(Cannot get a XML response.)")})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),printErrorMessage("Cannot create upload token !<br>(Cannot connect to kaltura server.)")}))}(serverHost,ks),!0));var nameStr,tagsStr,descStr,flag,serverHost,ks}function printErrorMessage(errorMessage,ks,uploadTokenId){""!==ks&&""!==uploadTokenId&&deleteUploadToken(),$("#upload_info").html(""),$("#upload_info").append('<font color="red">'+errorMessage+"</font><br>"),disableInsertButton(),enableCancelButton()}function disableInsertButton(){$("#yukaltura_insert_btn",parent.document).prop("disabled",!0),$("#yukaltura_insert_btn",parent.document).css({opacity:"0.5"})}function enableCancelButton(){$("#yukaltura_cancel_btn",parent.document).prop("disabled",!1),$("#yukaltura_cancel_btn",parent.document).css({opacity:"1.0"})}function deleteUploadToken(serverHost,ks,uploadTokenId){var flag,fd=new FormData;fd.append("action","delete"),fd.append("ks",ks),fd.append("uploadTokenId",uploadTokenId);var postData={type:"POST",data:fd,cache:!1,contentType:!1,scriptCharset:"utf-8",processData:!1,async:!0,dataType:"xml"},serviceURL=serverHost+"/api_v3/service/uploadToken/action/delete";return $.ajax(serviceURL,postData).done((function(xmlData){null===xmlData&&(flag=!1),flag=!0})).fail((function(xmlData){flag=!1,null!==xmlData&&window.console.dir(xmlData)})),flag}$(window).on("change",(function(){checkForm()})),$(window).on("unload",(function(){var serviceURL;serviceURL=$("#kalturahost").val()+"/api_v3/service/session/action/end",$.ajax({type:"GET",url:serviceURL,cache:!1}).done((function(xmlData){null===xmlData?window.console.log("Cannot delete the uploadToken ! (Cannot get a XML response.)"):window.console.log("Kaltura Session has been deleted.")})).fail((function(xmlData){window.console.log("Cannot delete the uploadToken ! (Cannot connect to content server.)"),null!==xmlData&&window.console.dir(xmlData)}))})),$("#fileData").on("change",(function(){!function(){var fileType,alertInfo="";if($("#fileData")){var file=$("#fileData").prop("files")[0];fileSize=parseInt(file.size);var typeResult=-1!=(fileType=encodeURI(file.type)).indexOf("video/avi")||-1!=fileType.indexOf("video/x-msvideo")||-1!=fileType.indexOf("video/mpeg")||-1!=fileType.indexOf("video/mpg")||-1!=fileType.indexOf("video/mp4")||-1!=fileType.indexOf("video/ogg")||-1!=fileType.indexOf("video/quicktime")||-1!=fileType.indexOf("video/VP8")||-1!=fileType.indexOf("video/x-flv")||-1!=fileType.indexOf("video/x-f4v")||-1!=fileType.indexOf("video/x-matroska")||-1!=fileType.indexOf("video/x-ms-wmv")||-1!=fileType.indexOf("video/webm")?"video":-1!=fileType.indexOf("audio/ac3")||-1!=fileType.indexOf("audio/ogg")||-1!=fileType.indexOf("audio/mpeg")||-1!=fileType.indexOf("audio/mp4")||-1!=fileType.indexOf("audio/mp3")||-1!=fileType.indexOf("audio/wav")||-1!=fileType.indexOf("audio/x-ms-wma")?"audio":-1!=fileType.indexOf("image/gif")||-1!=fileType.indexOf("image/jpeg")||-1!=fileType.indexOf("image/png")||-1!=fileType.indexOf("image/tiff")?"image":"N/A",sizeResult=checkFileSize();if(require(["core/str","core/notification"],(function(str,notification){return str.get_strings([{key:"wrong_filesize",component:"local_yumymedia"},{key:"unsupported_filetype",component:"local_yumymedia"},{key:"filesize",component:"local_yumymedia"},{key:"mimetype",component:"local_yumymedia"}]).then((function(results){if(!1===sizeResult&&(alertInfo+=results[0]),"N/A"==typeResult&&(alertInfo+=results[1]),""!==alertInfo)window.alert(alertInfo),$("#file_info").html(""),$("#name").val(""),$("#tags").val(""),$("#description").val(""),$("#type").val(""),$("#fileData").val(""),naturalWidth=0,naturalHeight=0,uploadFileType="";else{var fileInfo="",sizeStr="";fileName=file.name,sizeStr=fileSize>1073741824?(fileSize/1073741824).toFixed(2)+" G":fileSize>1048576?(fileSize/1048576).toFixed(2)+" M":fileSize>1024?(fileSize/1024).toFixed(2)+" k":fileSize+" ",fileInfo+="<div id=metadata_fields>",fileInfo+=results[2]+": "+sizeStr+"bytes<br>",fileInfo+=results[3]+":"+encodeURI(file.type)+"<br>",fileInfo+="</div><hr>",$("#file_info").html(fileInfo),$("#name").val(fileName),$("#type").val(typeResult)}return 0})).fail(notification.exception),0})),"image"==typeResult){var image=new Image;image.onload=function(){naturalWidth=image.naturalWidth,naturalHeight=image.naturalHeight,revokeObjectURL(image.src),window.console.log(naturalWidth),window.console.log(naturalHeight)},image.src=createObjectURL(file)}else naturalWidth=0,naturalHeight=0;uploadFileType=typeResult}checkForm()}()})),$("#name").on("change",(function(){checkForm()})),$("#tags").on("change",(function(){checkForm()})),$("#entry_submit").on("click",(function(){handleSubmitClick()})),$("#entry_reset").on("click",(function(){$("#file_info").html(""),$("#type").val(""),uploadFileType="",naturalWidth=0,naturalHeight=0})),$("#yukaltura_select_id",parent.document).remove(),$("#yukaltura_select_name",parent.document).remove(),$("#yukaltura_host",parent.document).remove(),$("#yukaltura_partnerid",parent.document).remove(),$("#yukaltura_uiconfid",parent.document).remove(),$("#yukaltura_playerstudio",parent.document).remove(),$("#yukaltura_width",parent.document).remove(),$("#yukaltura_height",parent.document).remove(),$("#yukaltura_filetype",parent.document).remove(),$("#yukaltura_naturalwidth",parent.document).remove(),$("#yukaltura_naturalheight",parent.document).remove(),disableInsertButton(),enableCancelButton()}}}));

//# sourceMappingURL=attouploader.min.js.map